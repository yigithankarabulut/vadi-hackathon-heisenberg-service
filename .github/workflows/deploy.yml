name: Heisenberg Service CI/CD Pipeline

on:
  push:
    branches: [ "main", "test" ]

env:
  IMAGE_NAME: vadi-hackathon-heisenberg-service
  DEPLOYMENT_NAME: heisenberg-service-deployment
  CONTAINER_NAME: heisenberg-service-container

jobs:
  build_and_push:
    name: üê≥ Build & Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and Push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}

  deploy_test:
    name: üß™ Deploy to TEST
    needs: build_and_push
    if: github.ref == 'refs/heads/test'
    runs-on: ubuntu-latest
    environment:
      name: test
    steps:
      - name: Deploy with Robust Retry
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          HOST="${{ secrets.SERVER_IP }}"
          USER="${{ secrets.SSH_USER }}"
          
          REMOTE_SCRIPT="
            echo 'üöÄ Deploying to TEST environment...'
            kubectl get namespace test > /dev/null 2>&1 || kubectl create namespace test
            kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} ${{ env.CONTAINER_NAME }}=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} -n test
            kubectl rollout restart deployment/${{ env.DEPLOYMENT_NAME }} -n test
            echo '‚úÖ Deployment to TEST complete.'
          "

          # --- RETRY LOOP ---
          set +e
          
          RETRIES=5
          for i in $(seq 1 $RETRIES); do
            echo "Connection attempt $i / $RETRIES..."
            
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa $USER@$HOST "$REMOTE_SCRIPT"
            
            if [ $? -eq 0 ]; then
              echo "üéâ Deployment SUCCESS!"
              exit 0
            fi
            
            echo "‚ö†Ô∏è Connection error (Connection Reset). 5 seconds later, trying again..."
            sleep 5
          done
          
          echo "‚ùå $RETRIES attempt failed."
          exit 1

  deploy_prod:
    name: üöÄ Deploy to PRODUCTION
    needs: build_and_push
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Deploy with Robust Retry
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          HOST="${{ secrets.SERVER_IP }}"
          USER="${{ secrets.SSH_USER }}"
          
          REMOTE_SCRIPT="
            echo 'üö® Deploying to PRODUCTION environment...'
            kubectl get namespace prod > /dev/null 2>&1 || kubectl create namespace prod
            kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} ${{ env.CONTAINER_NAME }}=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} -n prod
            kubectl rollout restart deployment/${{ env.DEPLOYMENT_NAME }} -n prod
            echo '‚úÖ Deployment to PROD complete.'
          "

          # --- RETRY LOOP ---
          set +e 
          
          RETRIES=5
          for i in $(seq 1 $RETRIES); do
            echo "Connection attempt $i / $RETRIES..."
            
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa $USER@$HOST "$REMOTE_SCRIPT"
            
            if [ $? -eq 0 ]; then
              echo "üéâ Deployment SUCCESS!"
              exit 0
            fi
            
            echo "‚ö†Ô∏è Connection error (Connection Reset). 5 seconds later, trying again..."
            sleep 5
          done
          
          echo "‚ùå $RETRIES attempt failed."
          exit 1